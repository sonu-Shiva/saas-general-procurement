#!/bin/bash
# Pre-commit validation hook to prevent regressions

echo "ğŸ” Running pre-commit validation..."

# Check TypeScript diagnostics
echo "Checking TypeScript diagnostics..."
if npx tsc --noEmit --skipLibCheck 2>/dev/null; then
    echo "âœ… TypeScript diagnostics clean"
else
    echo "âŒ TypeScript errors found - commit blocked"
    exit 1
fi

# Validate core API endpoints
echo "Testing core API endpoints..."
if ./validate-system.sh | grep -q "âœ—"; then
    echo "âŒ API endpoint validation failed - commit blocked"
    exit 1
else
    echo "âœ… All API endpoints working"
fi

# Check for common regression patterns
echo "Checking for regression patterns..."

# Check for incomplete API signature updates
if grep -r "apiRequest.*POST\|apiRequest.*PUT\|apiRequest.*DELETE" client/src/ --include="*.tsx" --include="*.ts" 2>/dev/null; then
    echo "âŒ Found old API signature usage - update to new format"
    exit 1
fi

# Check for schema import issues
if grep -r "auctionBids\|purchaseOrderItems\|directProcurementOrderItems" server/ --include="*.ts" 2>/dev/null; then
    echo "âŒ Found non-existent schema imports"
    exit 1
fi

echo "âœ… Pre-commit validation passed"
echo "ğŸš€ Safe to commit changes"